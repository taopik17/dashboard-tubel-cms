<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Tugas Belajar ASN Kab. Ciamis</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    h1 { margin-bottom: 4px; }
    .subtitle { color: #555; margin-top: 0; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 12px 0 16px; }
    .kpis { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin: 16px 0; }
    .kpi { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,.05); }
    .kpi .label { font-size: 12px; color: #666; }
    .kpi .value { font-weight: 700; font-size: 28px; line-height: 1.1; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 1100px) {
      .grid { grid-template-columns: 1.1fr 1fr; }
    }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; }
    .card h3 { margin: 6px 8px; font-size: 16px; }
    select { padding: 8px 10px; border-radius: 8px; border: 1px solid #d1d5db; }
    .footer { margin-top: 24px; color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>DASHBOARD MONITORING TUGAS BELAJAR</h1>
  <p class="subtitle">ASN Kabupaten Ciamis • Interaktif (filter berdasarkan tahun)</p>
  <div class="controls">
    <label for="yearFilter"><b>Filter Tahun:</b></label>
    <select id="yearFilter">
      <option value="All">Semua Tahun</option>
    </select>
  </div>

  <div class="kpis">
    <div class="kpi"><div class="label">Total Peserta</div><div class="value" id="kpiTotal">0</div></div>
    <div class="kpi"><div class="label">Jumlah Unit Kerja</div><div class="value" id="kpiUnit">0</div></div>
    <div class="kpi"><div class="label">Jumlah Lembaga Pendidikan</div><div class="value" id="kpiLembaga">0</div></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Tren Peserta per Tahun</h3>
      <div id="trendChart"></div>
    </div>
    <div class="card">
      <h3>Distribusi Jenjang Pendidikan</h3>
      <div id="jenjangPie"></div>
    </div>
    <div class="card">
      <h3>Top 10 Unit Kerja</h3>
      <div id="unitBar"></div>
    </div>
    <div class="card">
      <h3>Top 10 Lembaga Pendidikan</h3>
      <div id="lembagaBar"></div>
    </div>
  </div>

  <div class="footer">Sumber data: Google Spreadsheet TUGAS BELAJAR PNS (2022–2025) • Terhubung otomatis</div>

  <script>
  const SHEET_ID = "1990d2qXEm1HqUMDvSCGD-tRKLWSPp7UdigBIpLg7reM";
  const SHEETS = ["2","3","4","5"]; // tab 2022–2025

  async function fetchSheet(sheet) {
    const url = `https://opensheet.elk.sh/${SHEET_ID}/${sheet}`;
    const resp = await fetch(url, { cache: "no-store" });
    return resp.json();
  }

  function normYear(r) {
    return r["Tahun"] || r["TAHUN"] || (r["TAHUN AJARAN"]?.match(/\d{4}/)?.[0] ?? "");
  }

  function normalizeRow(r) {
    return {
      "NAMA": r["NAMA"] || r["Nama"] || "",
      "UNIT KERJA": r["UNIT KERJA"] || r["Unit Kerja"] || "",
      "JENJANG PENDIDIKAN": r["JENJANG PENDIDIKAN"] || r["Jenjang"] || "",
      "LEMBAGA PENDIDIKAN": r["LEMBAGA PENDIDIKAN"] || r["Perguruan Tinggi"] || "",
      "Tahun": normYear(r)
    };
  }

  async function loadAllData() {
    const all = await Promise.all(SHEETS.map(fetchSheet));
    return all.flat().map(normalizeRow).filter(x => x["NAMA"]);
  }

  function updateDashboard(rawData) {
    document.getElementById("kpiTotal").textContent = rawData.length;
    document.getElementById("kpiUnit").textContent = new Set(rawData.map(d=>d["UNIT KERJA"])).size;
    document.getElementById("kpiLembaga").textContent = new Set(rawData.map(d=>d["LEMBAGA PENDIDIKAN"])).size;

    const years = Array.from(new Set(rawData.map(d=>d.Tahun))).sort();
    const sel = document.getElementById("yearFilter");
    sel.innerHTML = '<option value="All">Semua Tahun</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join("");

    sel.onchange = () => {
      const val = sel.value;
      const filtered = val==="All" ? rawData : rawData.filter(d=>d.Tahun===val);
      drawCharts(filtered);
    };

    drawCharts(rawData);
  }

  function drawCharts(rawData) {
    const countByYear = {};
    rawData.forEach(d => { countByYear[d.Tahun] = (countByYear[d.Tahun]||0)+1; });
    const years = Object.keys(countByYear).sort();
    const vals = years.map(y=>countByYear[y]);
    Plotly.react("trendChart", [{x:years, y:vals, type:"scatter", mode:"lines+markers"}], {margin:{t:10}});

    const jenjangCount = {};
    rawData.forEach(d => { jenjangCount[d["JENJANG PENDIDIKAN"]] = (jenjangCount[d["JENJANG PENDIDIKAN"]]||0)+1; });
    Plotly.react("jenjangPie", [{labels:Object.keys(jenjangCount), values:Object.values(jenjangCount), type:"pie"}], {margin:{t:10}});

    const unitCount = {};
    rawData.forEach(d => { unitCount[d["UNIT KERJA"]] = (unitCount[d["UNIT KERJA"]]||0)+1; });
    const units = Object.entries(unitCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
    Plotly.react("unitBar", [{x:units.map(u=>u[1]), y:units.map(u=>u[0]), type:"bar", orientation:"h"}], {margin:{l:150,t:10}, yaxis:{autorange:"reversed"}});

    const lembCount = {};
    rawData.forEach(d => { lembCount[d["LEMBAGA PENDIDIKAN"]] = (lembCount[d["LEMBAGA PENDIDIKAN"]]||0)+1; });
    const lemb = Object.entries(lembCount).sort((a,b)=>b[1]-a[1]).slice(0,10);
    Plotly.react("lembagaBar", [{x:lemb.map(l=>l[1]), y:lemb.map(l=>l[0]), type:"bar", orientation:"h"}], {margin:{l:150,t:10}, yaxis:{autorange:"reversed"}});
  }

  loadAllData().then(updateDashboard).catch(e=>console.error(e));
  </script>
</body>
</html>
