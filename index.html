<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Tugas Belajar ASN Kab. Ciamis</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root{--card:#e5e7eb}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}
    h1{margin-bottom:4px}
    .subtitle{color:#555;margin-top:0}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0 16px}
    select{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin:16px 0}
    .kpi{border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .kpi .label{font-size:12px;color:#666}
    .kpi .value{font-weight:700;font-size:28px;line-height:1.1}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:1100px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .card h3{margin:6px 8px;font-size:16px}
    .footer{margin-top:24px;color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>DASHBOARD MONITORING TUGAS BELAJAR</h1>
  <p class="subtitle">ASN Kabupaten Ciamis • Data live dari Google Spreadsheet</p>

  <div class="controls">
    <label for="yearFilter"><b>Filter Tahun:</b></label>
    <select id="yearFilter">
      <option value="All">Semua Tahun</option>
    </select>
  </div>

  <div class="kpis">
    <div class="kpi"><div class="label">Total Peserta</div><div class="value" id="kpiTotal">0</div></div>
    <div class="kpi"><div class="label">Jumlah Unit Kerja</div><div class="value" id="kpiUnit">0</div></div>
    <div class="kpi"><div class="label">Jumlah Lembaga Pendidikan</div><div class="value" id="kpiLembaga">0</div></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Program Studi</h3>
      <div id="prodiPie"></div>
    </div>
    <div class="card">
      <h3>Jenjang Pendidikan</h3>
      <div id="jenjangBar"></div>
    </div>
    <div class="card">
      <h3>Lembaga Pendidikan</h3>
      <div id="lembagaPie"></div>
    </div>
    <div class="card">
      <h3>Keterangan</h3>
      <div id="ketBar"></div>
    </div>
  </div>

  <div class="footer">
    Sumber: Google Sheets (tab 2022–2025) • Otomatis update saat data di spreadsheet berubah
  </div>

  <script>
  // ==== KONFIG ====
  const SHEET_ID = "1990d2qXEm1HqUMDvSCGD-tRKLWSPp7UdigBIpLg7reM";
  // Tab 2022–2025 (bisa pakai nama atau index "2","3","4","5")
  const SHEETS = ["2","3","4","5"];

  // ==== FETCH & NORMALISASI ====
  async function fetchSheet(sheet) {
    const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheet)}`;
    const resp = await fetch(url, { cache: "no-store" });
    if (!resp.ok) throw new Error(`Gagal fetch sheet ${sheet}`);
    return resp.json();
  }

  function firstMatchKey(rows, candidates) {
    // cari key yang ada pada salah satu row
    for (const c of candidates) {
      const found = rows.find(r => Object.prototype.hasOwnProperty.call(r, c));
      if (found) return c;
    }
    // fallback: pakai kandidat pertama
    return candidates[0];
  }

  function normYear(row) {
    const t1 = row["Tahun"] || row["TAHUN"] || row["tahun"];
    if (t1) return String(t1).trim();
    const ta = row["TAHUN AJARAN"] || row["Tahun Ajaran"];
    if (ta) {
      const m = String(ta).match(/\d{4}/);
      if (m) return m[0];
    }
    return "";
  }

  function normalizeRow(r, keys) {
    return {
      "NAMA": r[keys.nama] ?? "",
      "UNIT KERJA": r[keys.unit] ?? "",
      "JENJANG PENDIDIKAN": r[keys.jenjang] ?? "",
      "LEMBAGA PENDIDIKAN": r[keys.lembaga] ?? "",
      "PROGRAM STUDI": r[keys.prodi] ?? "",
      "KETERANGAN": r[keys.ket] ?? "",
      "Tahun": normYear(r)
    };
  }

  async function loadAllData() {
    const all = await Promise.all(SHEETS.map(fetchSheet));
    const mergedRaw = all.flat();

    // Tentukan key yang benar berdasar header di sheet
    const rowsSample = mergedRaw.slice(0, 50); // cukup sample
    const keys = {
      nama:    firstMatchKey(rowsSample, ["NAMA","Nama","NAMA LENGKAP","Nama Lengkap"]),
      unit:    firstMatchKey(rowsSample, ["UNIT KERJA","Unit Kerja","OPD"]),
      jenjang: firstMatchKey(rowsSample, ["JENJANG PENDIDIKAN","Jenjang Pendidikan","Jenjang"]),
      lembaga: firstMatchKey(rowsSample, ["LEMBAGA PENDIDIKAN","Lembaga Pendidikan","Perguruan Tinggi","Universitas"]),
      prodi:   firstMatchKey(rowsSample, ["PROGRAM STUDI","Program Studi","PROGRAM","Program"]),
      ket:     firstMatchKey(rowsSample, ["KETERANGAN","Keterangan","KET"])
    };

    const normalized = mergedRaw.map(r => normalizeRow(r, keys))
      .filter(x => (x["NAMA"] || x["UNIT KERJA"] || x["LEMBAGA PENDIDIKAN"]));

    return normalized;
  }

  // ==== RENDER KPI & CHART ====
  function renderKPIs(data) {
    document.getElementById("kpiTotal").textContent   = data.length;
    document.getElementById("kpiUnit").textContent    =
      new Set(data.map(d => (d["UNIT KERJA"]||"").trim()).filter(Boolean)).size;
    document.getElementById("kpiLembaga").textContent =
      new Set(data.map(d => (d["LEMBAGA PENDIDIKAN"]||"").trim()).filter(Boolean)).size;
  }

  function countBy(arr, key) {
    const map = {};
    for (const d of arr) {
      const v = (d[key] || "").toString().trim();
      if (!v) continue;
      map[v] = (map[v] || 0) + 1;
    }
    return map;
  }

  function drawCharts(data) {
    // 1) Program Studi → PIE
    const prodiCount = countBy(data, "PROGRAM STUDI");
    Plotly.react("prodiPie", [{
      labels: Object.keys(prodiCount),
      values: Object.values(prodiCount),
      type: "pie"
    }], { margin: { t: 10 } });

    // 2) Jenjang Pendidikan → BAR
    const jenjangCount = countBy(data, "JENJANG PENDIDIKAN");
    const jLabels = Object.keys(jenjangCount);
    const jVals   = jLabels.map(k => jenjangCount[k]);
    Plotly.react("jenjangBar", [{
      x: jLabels, y: jVals, type: "bar",
      text: jVals.map(String), textposition: "outside",
      hovertemplate: "%{x}<br>%{y} peserta<extra></extra>"
    }], {
      margin:{ t:10, r:10, b:40, l:50 },
      xaxis:{ title:"Jenjang", tickangle:-15 },
      yaxis:{ title:"Jumlah", rangemode:"tozero" },
      uniformtext:{ minsize:10, mode:"hide" }
    });

    // 3) Lembaga Pendidikan → PIE
    const lembCount = countBy(data, "LEMBAGA PENDIDIKAN");
    Plotly.react("lembagaPie", [{
      labels: Object.keys(lembCount),
      values: Object.values(lembCount),
      type: "pie"
    }], { margin: { t: 10 } });

    // 4) Keterangan → BAR (horizontal)
    const ketCount = countBy(data, "KETERANGAN");
    const kEntries = Object.entries(ketCount).sort((a,b)=>b[1]-a[1]);
    Plotly.react("ketBar", [{
      x: kEntries.map(e => e[1]),
      y: kEntries.map(e => e[0]),
      type: "bar", orientation: "h",
      text: kEntries.map(e => e[1].toString()),
      textposition: "outside",
      hovertemplate: "%{y}<br>%{x} peserta<extra></extra>"
    }], {
      margin:{ l:160, t:10, r:20, b:30 },
      yaxis:{ autorange:"reversed" },
      xaxis:{ rangemode:"tozero" }
    });
  }

  // ==== BOOTSTRAP ====
  let fullData = []; // semua tahun
  let currentData = [];

  function setupFilter() {
    const sel = document.getElementById("yearFilter");
    const years = Array.from(new Set(fullData.map(d => d.Tahun).filter(Boolean))).sort();
    sel.innerHTML = '<option value="All">Semua Tahun</option>' +
      years.map(y => `<option value="${y}">${y}</option>`).join("");
    sel.value = "All";

    sel.onchange = () => {
      const val = (sel.value ?? "").trim();
      currentData = (val === "All" || val === "") ? fullData.slice()
        : fullData.filter(d => String(d.Tahun).trim() === String(val));
      renderKPIs(currentData);
      drawCharts(currentData);
    };
  }

  (async function init() {
    try {
      fullData = await loadAllData();
      currentData = fullData.slice();

      setupFilter();
      renderKPIs(currentData);
      drawCharts(currentData);

      // OPTIONAL: auto-refresh tiap 10 menit
      // setInterval(async () => {
      //   fullData = await loadAllData();
      //   document.getElementById("yearFilter").dispatchEvent(new Event('change'));
      // }, 10*60*1000);

    } catch (e) {
      console.error(e);
      alert("Gagal memuat data dari Google Sheets. Pastikan tab 2022–2025 dipublish & header konsisten.");
    }
  })();
  </script>
</body>
</html>
