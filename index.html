<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Tugas Belajar ASN Kab. Ciamis</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root{--card:#e5e7eb}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}
    h1{margin-bottom:4px}
    .subtitle{color:#555;margin-top:0}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0 16px}
    select{padding:8px 10px;border-radius:8px;border:1px solid #d1d5db}
    .kpis{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));margin:16px 0}
    .kpi{border:1px solid #e5e7eb;border-radius:12px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .kpi .label{font-size:12px;color:#666}
    .kpi .value{font-weight:700;font-size:28px;line-height:1.1}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:1100px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .card h3{margin:6px 8px;font-size:16px}
    .footer{margin-top:24px;color:#666;font-size:12px}
  </style>
</head>
<body>
  <h1>DASHBOARD MONITORING TUGAS BELAJAR</h1>
  <p class="subtitle">ASN Kabupaten Ciamis • Data live dari Google Spreadsheet</p>

  <div class="controls">
    <label for="yearFilter"><b>Filter Tahun:</b></label>
    <select id="yearFilter">
      <option value="All">Semua Tahun</option>
    </select>
  </div>

  <div class="kpis">
    <div class="kpi"><div class="label">Total Peserta</div><div class="value" id="kpiTotal">0</div></div>
    <div class="kpi"><div class="label">Jumlah Unit Kerja</div><div class="value" id="kpiUnit">0</div></div>
    <div class="kpi"><div class="label">Jumlah Lembaga Pendidikan</div><div class="value" id="kpiLembaga">0</div></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Program Studi</h3>
      <div id="prodiPie"></div>
    </div>
    <div class="card">
      <h3>Jenjang Pendidikan</h3>
      <div id="jenjangBar"></div>
    </div>
    <div class="card">
      <h3>Lembaga Pendidikan</h3>
      <div id="lembagaPie"></div>
    </div>
    <div class="card">
      <h3>Keterangan</h3>
      <div id="ketBar"></div>
    </div>
  </div>

  <div class="footer">
    Sumber: Google Sheets (tab 2022–2025) • Otomatis update saat data di spreadsheet berubah
  </div>

  <script>
/* ====== KONFIG ====== */
const SHEET_ID = "1990d2qXEm1HqUMDvSCGD-tRKLWSPp7UdigBIpLg7reM";
// Tab 2022–2025 (bisa pakai index "2","3","4","5" atau nama tab)
const SHEETS = ["2","3","4","5"];

/* ====== UTIL ====== */
async function fetchSheet(sheet) {
  const url = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent(sheet)}`;
  const resp = await fetch(url, { cache: "no-store" });
  if (!resp.ok) throw new Error(`Fetch gagal: ${sheet}`);
  return resp.json();
}

// cari key secara case-insensitive, abaikan spasi/underscore
function pickKey(rows, candidates) {
  const norm = s => String(s).toLowerCase().replace(/[\s_]+/g,'');
  const candNorm = candidates.map(norm);
  for (const r of rows) {
    for (const k of Object.keys(r)) {
      const kn = norm(k);
      const i = candNorm.indexOf(kn);
      if (i !== -1) return k; // k = nama persis di sheet
    }
  }
  // try contains
  for (const r of rows) {
    for (const k of Object.keys(r)) {
      const kn = norm(k);
      if (candNorm.some(c => kn.includes(c) || c.includes(kn))) return k;
    }
  }
  return candidates[0]; // fallback
}

function normYear(row) {
  const t1 = row["Tahun"] ?? row["TAHUN"] ?? row["tahun"];
  if (t1) return String(t1).trim();
  const ta = row["TAHUN AJARAN"] ?? row["Tahun Ajaran"];
  if (ta) {
    const m = String(ta).match(/\d{4}/);
    if (m) return m[0];
  }
  return "";
}

function countBy(arr, key) {
  const map = {};
  for (const d of arr) {
    const v = (d[key] ?? "").toString().trim();
    if (!v) continue;
    map[v] = (map[v] || 0) + 1;
  }
  return map;
}

/* ====== LOAD + NORMALISASI ====== */
async function loadAllData() {
  const all = await Promise.all(SHEETS.map(fetchSheet));
  const merged = all.flat();

  // deteksi header berdasarkan sample
  const sample = merged.slice(0, 100);
  const keys = {
    nama:    pickKey(sample, ["NAMA","Nama","Nama Lengkap","NAMA LENGKAP"]),
    unit:    pickKey(sample, ["UNIT KERJA","Unit Kerja","OPD"]),
    jenjang: pickKey(sample, ["JENJANG PENDIDIKAN","Jenjang Pendidikan","Jenjang"]),
    lembaga: pickKey(sample, ["LEMBAGA PENDIDIKAN","Lembaga Pendidikan","Perguruan Tinggi","Universitas"]),
    prodi:   pickKey(sample, ["PROGRAM STUDI","Program Studi","PRODI","Program"]),
    ket:     pickKey(sample, ["KETERANGAN","Keterangan","KET"])
  };

  // normalisasi → pakai properti konsisten
  const normalized = merged.map(r => ({
    Nama:      r[keys.nama]    ?? "",
    Unit:      r[keys.unit]    ?? "",
    Jenjang:   r[keys.jenjang] ?? "",
    Lembaga:   r[keys.lembaga] ?? "",
    Prodi:     r[keys.prodi]   ?? "",
    Ket:       r[keys.ket]     ?? "",
    Tahun:     normYear(r)
  }))
  .filter(x => x.Unit || x.Lembaga || x.Nama); // buang baris kosong

  return normalized;
}

/* ====== KPI & CHARTS ====== */
function renderKPIs(data) {
  document.getElementById("kpiTotal").textContent   = data.length;
  document.getElementById("kpiUnit").textContent    =
    new Set(data.map(d => (d.Unit||"").trim()).filter(Boolean)).size;
  document.getElementById("kpiLembaga").textContent =
    new Set(data.map(d => (d.Lembaga||"").trim()).filter(Boolean)).size;
}

function drawCharts(data) {
  // 1) Program Studi (pie)
  const prodi = countBy(data, "Prodi");
  Plotly.react("prodiPie", [{
    labels: Object.keys(prodi),
    values: Object.values(prodi),
    type: "pie"
  }], { margin:{t:10} });

  // 2) Jenjang Pendidikan (bar)
  const jenj = countBy(data, "Jenjang");
  const jLabels = Object.keys(jenj);
  const jVals   = jLabels.map(k => jenj[k]);
  Plotly.react("jenjangBar", [{
    x: jLabels, y: jVals, type:"bar",
    text: jVals.map(String), textposition:"outside",
    hovertemplate:"%{x}<br>%{y} peserta<extra></extra>"
  }], {
    margin:{t:10,r:10,b:40,l:50},
    xaxis:{title:"Jenjang", tickangle:-15},
    yaxis:{title:"Jumlah", rangemode:"tozero"},
    uniformtext:{minsize:10,mode:"hide"}
  });

  // 3) Lembaga Pendidikan (pie)
  const lemb = countBy(data, "Lembaga");
  Plotly.react("lembagaPie", [{
    labels: Object.keys(lemb),
    values: Object.values(lemb),
    type:"pie"
  }], { margin:{t:10} });

  // 4) Keterangan (bar horizontal)
  const ket = countBy(data, "Ket");
  const kEntries = Object.entries(ket).sort((a,b)=>b[1]-a[1]);
  Plotly.react("ketBar", [{
    x: kEntries.map(e=>e[1]),
    y: kEntries.map(e=>e[0]),
    type:"bar", orientation:"h",
    text: kEntries.map(e=>String(e[1])),
    textposition:"outside",
    hovertemplate:"%{y}<br>%{x} peserta<extra></extra>"
  }], {
    margin:{l:160,t:10,r:20,b:30},
    yaxis:{autorange:"reversed"},
    xaxis:{rangemode:"tozero"}
  });
}

/* ====== BOOTSTRAP + FILTER ====== */
let fullData = [];
let currentData = [];

function setupFilter() {
  const sel = document.getElementById("yearFilter");
  const years = Array.from(new Set(fullData.map(d => d.Tahun).filter(Boolean))).sort();
  sel.innerHTML = '<option value="All">Semua Tahun</option>' +
    years.map(y => `<option value="${y}">${y}</option>`).join("");
  sel.value = "All";

  sel.onchange = () => {
    const val = (sel.value ?? "").trim();
    currentData = (val === "All" || val === "")
      ? fullData.slice()
      : fullData.filter(d => String(d.Tahun).trim() === String(val));
    renderKPIs(currentData);
    drawCharts(currentData);
  };
}

(async function init() {
  try {
    fullData = await loadAllData();
    currentData = fullData.slice();

    setupFilter();       // isi dropdown tahun
    renderKPIs(currentData);
    drawCharts(currentData);
  } catch (e) {
    console.error(e);
    alert("Gagal memuat data. Pastikan tab 2022–2025 sudah dipublish & header konsisten.");
  }
})();
</script>

</body>
</html>
