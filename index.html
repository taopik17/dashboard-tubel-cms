<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Tugas Belajar ASN Kab. Ciamis</title>
  <!-- Plotly & PapaParse CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{--bg:#0b1021;--card:#11162a;--muted:#8a94a6;--line:#202745}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1021,#0d1226 60%,#0b1021);color:#eef2ff}
    header{padding:20px 16px 10px;max-width:1100px;margin:0 auto}
    h1{margin:0 0 6px;font-size:24px}
    .subtitle{margin:0;color:var(--muted);font-size:14px}
    .wrap{max-width:1100px;margin:14px auto 32px;padding:0 16px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0 18px}
    .control{display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--card);border:1px solid var(--line);border-radius:12px}
    select{appearance:none;background:transparent;border:none;color:#eef2ff;font-weight:600;outline:none}
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)}
    .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
    @media(min-width:900px){.card{grid-column:span 6}}
    .card h3{margin:6px 6px 0;font-size:16px;color:#c7d2fe}
    .footer{color:var(--muted);font-size:12px;text-align:center;margin:22px 0 28px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0f1736;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:#c7d2fe;font-size:12px}
    .hint{color:var(--muted);font-size:12px}
    .btn{cursor:pointer;border:1px solid var(--line);background:#0f1736;border-radius:10px;padding:8px 10px;color:#c7d2fe}
    a{color:#c7d2fe}
  </style>
</head>
<body>
  <header>
    <h1>Dashboard Tugas Belajar ASN Kab. Ciamis</h1>
    <p class="subtitle">Filter berdasarkan tahun (2022–2025). Empat panel: Program Studi, Jenjang Pendidikan, Lembaga Pendidikan, Keterangan.</p>
  </header>

  <div class="wrap">
    <div class="controls">
      <div class="control">
        <span class="hint">Tahun</span>
        <select id="yearSelect" aria-label="Pilih Tahun"></select>
      </div>
      <button id="refreshBtn" class="btn" title="Muat ulang data">Muat ulang</button>
      <span class="badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 5h18M3 12h18M3 19h18" stroke="#7c88b8" stroke-width="2" stroke-linecap="round"/></svg> Database → Grafik otomatis</span>
    </div>

    <p class="hint" style="margin:0 0 10px">Catatan: ganti <code>SHEET_CSV_URL</code> di skrip dengan link CSV publik sheet <b>Database</b> Anda (File → Publish to the web → pilih sheet <i>Database</i> → CSV).</p>

    <div class="grid">
      <section class="card"><h3>Program Studi (Top 15)</h3><div id="chartProdi" style="height:420px"></div></section>
      <section class="card"><h3>Jenjang Pendidikan</h3><div id="chartJenjang" style="height:420px"></div></section>
      <section class="card"><h3>Lembaga Pendidikan (Top 15)</h3><div id="chartLembaga" style="height:420px"></div></section>
      <section class="card"><h3>Keterangan</h3><div id="chartKet" style="height:420px"></div></section>
    </div>

    <div class="footer">© BKPSDM Ciamis · Dibuat untuk visualisasi cepat dari Google Sheets</div>
  </div>

  <script>
    // ==============================
    // KONFIGURASI DATA
    // ==============================
    // 1) Ubah URL berikut menjadi CSV publik dari sheet "Database" Anda.
    //    Contoh format:
    //    https://docs.google.com/spreadsheets/d/e/XXXX/pub?gid=YYYY&single=true&output=csv
    //    atau menggunakan opensheet: https://opensheet.elk.sh/<SPREADSHEET_ID>/Database
    const SHEET_CSV_URL = "https://opensheet.elk.sh/1B9H4qfdjOgLVl7ZVk9FNvJF9D0Fy__IIvK8D5iAxATE/Database";

    // 2) Jika header kolom berbeda, ubah map di bawah ini.
    let COLS = {
      tahun: "Tahun",
      prodi: "Program Studi",
      jenjang: "Jenjang Pendidikan",
      lembaga: "Lembaga Pendidikan",
      ket: "Keterangan",
    };

    // ==============================
    // UTILITAS
    // ==============================
    function toTitle(s){return (s||"").toString().trim()}

    function countBy(arr, key){
      const m = new Map();
      for (const v of arr){
        const k = toTitle(v[key] ?? "");
        if(!k) continue;
        m.set(k, (m.get(k)||0)+1);
      }
      return m;
    }

    function topNWithOthers(map, N=15){
      const pairs = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
      if (pairs.length <= N) return pairs;
      const top = pairs.slice(0,N);
      const others = pairs.slice(N).reduce((s, [,v])=>s+v,0);
      if (others>0) top.push(["Lainnya", others]);
      return top;
    }

    function makeBarTrace(pairs){
      const labels = pairs.map(p=>p[0]);
      const values = pairs.map(p=>p[1]);
      return [{
        type:"bar",
        x: values,
        y: labels,
        orientation: "h",
        hovertemplate: "%{y}: %{x}<extra></extra>",
      }];
    }

    function layout(title){
      return {
        margin: {l: 140, r: 16, t: 8, b: 40},
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        xaxis: {gridcolor: "#2a335f"},
        yaxis: {gridcolor: "#2a335f", automargin:true},
        font: {color: "#e5e7eb"},
        hoverlabel: {bgcolor: "#11162a", font:{color:"#e5e7eb"}},
      };
    }

    function renderBar(domId, pairs){
      Plotly.react(domId, makeBarTrace(pairs), layout());
    }

    // ==============================
    // DATA LOADING & RENDER
    // ==============================
    let RAW = [];

    async function fetchCSV(url){
      async function getText(u){
        const rsp = await fetch(u);
        if(!rsp.ok) throw new Error("HTTP "+rsp.status);
        return await rsp.text();
      }
      async function getJSON(u){
        const rsp = await fetch(u);
        if(!rsp.ok) throw new Error("HTTP "+rsp.status);
        return await rsp.json();
      }
      if(!url || url.startsWith("PASTE_")){
        console.warn("Harap isi SHEET_CSV_URL.");
        return [];
      }
      // Jika memakai OpenSheet (JSON)
      if(url.includes("opensheet.elk.sh")){
        try{
          const json = await getJSON(url);
          if(Array.isArray(json) && json.length){ return json; }
        }catch(e){ console.error("Gagal fetch OpenSheet JSON:", e); }
        return [];
      }
      // Default: CSV Google (dengan fallback proxy read-only)
      try{
        const text = await getText(url);
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        if(parsed.data && parsed.data.length) return parsed.data;
        throw new Error("Parsed empty");
      }catch(err){
        try{
          const alt = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,"");
          const text = await getText(alt);
          const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
          if(parsed.data && parsed.data.length) return parsed.data;
        }catch(e){
          console.error("Gagal fetch CSV:", e);
        }
        return [];
      }
    }

    function getYears(data){
      const years = Array.from(new Set(data.map(r => (r[COLS.tahun]||"").toString().trim())));
      // Filter 2022-2025 dan urutkan menurun
      const allowed = new Set(["2022","2023","2024","2025"]);
      return years.filter(y=>allowed.has(y)).sort((a,b)=>b.localeCompare(a));
    }

    function filterByYear(data, year){
      return data.filter(r => (r[COLS.tahun]||"").toString().trim() === year);
    }

    function populateYearSelect(years){
      const sel = document.getElementById("yearSelect");
      sel.innerHTML = "";
      for(const y of years){
        const opt = document.createElement("option");
        opt.value = y; opt.textContent = y; sel.appendChild(opt);
      }
    }

    function updateAll(){
      const year = document.getElementById("yearSelect").value;
      const rows = filterByYear(RAW, year);

      // Hitung dan render
      const cProdi = countBy(rows, COLS.prodi);
      const cJenjang = countBy(rows, COLS.jenjang);
      const cLembaga = countBy(rows, COLS.lembaga);
      const cKet = countBy(rows, COLS.ket);

      renderBar("chartProdi", topNWithOthers(cProdi, 15));
      renderBar("chartJenjang", topNWithOthers(cJenjang, 10));
      renderBar("chartLembaga", topNWithOthers(cLembaga, 15));
      renderBar("chartKet", topNWithOthers(cKet, 10));
    }

    async function boot(){
      RAW = await fetchCSV(SHEET_CSV_URL);
      if(!RAW.length){
        // Tampilkan placeholder kosong agar halaman tidak blank
        populateYearSelect(["2025","2024","2023","2022"]);
        updateAll();
        return;
      }
      const years = getYears(RAW);
      populateYearSelect(years.length?years:["2025","2024","2023","2022"]);
      updateAll();
    }

    document.getElementById("yearSelect").addEventListener("change", updateAll);
    document.getElementById("refreshBtn").addEventListener("click", boot);
    boot();
  </script>
</body>
</html>
